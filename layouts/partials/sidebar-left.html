<aside class="panel nav" aria-label="Primary">
  <div class="panel-header"><span class="led on"></span> Menu</div>
  <div class="card">
    <div class="nav-buttons">
      {{ $sec := .Section }}
      {{ $isHome := .IsHome }}

      {{ $menu := site.Menus.main }}
      {{ if $menu }}
        {{ range $m := $menu }}
          {{/* -------------------------------
               안전한 href / ref 계산 (Scratch)
               href: 최종 링크
               ref : 섹션 키(활성화 판단용). "" 이면 홈
             -------------------------------- */}}
          {{ $.Scratch.Set "href" "" }}
          {{ $.Scratch.Set "ref"  "" }}

          {{ with $m.Page }}
            {{ $.Scratch.Set "href" .RelPermalink }}
            {{ $.Scratch.Set "ref"  .Section }}
          {{ else }}
            {{ with $m.PageRef }}
              {{ $clean := (trim . "/") }}
              {{ $.Scratch.Set "ref" $clean }}
              {{ if or (eq $clean "") (eq . "/") }}
                {{ $.Scratch.Set "href" ("/" | relURL) }}
              {{ else }}
                {{ $.Scratch.Set "href" ((printf "/%s/" $clean) | relURL) }}
              {{ end }}
            {{ else }}
              {{ with $m.URL }}
                {{ $.Scratch.Set "href" (. | relURL) }}
              {{ end }}
            {{ end }}
          {{ end }}

          {{ $href := $.Scratch.Get "href" }}
          {{ $ref  := $.Scratch.Get "ref" }}

          {{/* ref가 비어있으면 홈 메뉴로 간주 */}}
          {{ $active := or (and (eq $ref "") $isHome) (and (ne $ref "") (eq $sec $ref)) }}

          <a class="nav-btn {{ if $active }}active{{ end }}"
             href="{{ $href }}"
             data-view="{{ lower $m.Name }}">{{ $m.Name }}</a>
        {{ end }}
      {{ end }}
    </div>
  </div>
</aside>
